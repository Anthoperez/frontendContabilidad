<h2 mat-dialog-title>
  <mat-icon style="color: #3b82f6;">tune</mat-icon>
  Completar Datos del Reporte
</h2>

<mat-dialog-content class="dialog-content">
  <form [formGroup]="metadataForm">

    <div *ngIf="reportType === 'contrato'">
      <h3>Datos del Contrato</h3>
      
      <div class="form-section-grid cols-3">
        <mat-form-field appearance="outline">
          <mat-label>Año Ejecución</mat-label>
          <input matInput type="number" formControlName="anio" placeholder="Ej: 2025">
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Código Proyecto</mat-label>
          <input matInput formControlName="codigoProyecto" placeholder="Ej: INC20-1-P-006-23">
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Duración</mat-label>
          <input matInput formControlName="duracion" placeholder="Ej: 18 meses">
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Título / Descripción del Proyecto</mat-label>
          <textarea matInput formControlName="tituloProyecto" rows="2"></textarea>
        </mat-form-field>
      </div>
    </div>

    <h3>Información del Investigador</h3>
    <div class="form-section-grid cols-2">
      <mat-form-field appearance="outline">
        <mat-label>Nombre del Investigador</mat-label>
        <input matInput formControlName="investigador">
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Resolución (R.R.)</mat-label>
        <input matInput formControlName="rr_investigador">
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Fecha Inicio</mat-label>
        <input matInput formControlName="fechaInicio">
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Fecha Culminación</mat-label>
        <input matInput [matDatepicker]="pickerCulminacion" formControlName="fechaCulminacion" />
        <mat-datepicker-toggle matSuffix [for]="pickerCulminacion"></mat-datepicker-toggle>
        <mat-datepicker #pickerCulminacion></mat-datepicker>
      </mat-form-field>
    </div>

    <div *ngIf="reportType === 'contrato'">
      <h3>
        Estructura de Presupuesto 
        <span *ngIf="presupuestoEntidades.length > 0" style="font-size: 0.8em; color: #64748b; font-weight: normal; margin-left: 10px;">
          (Se suman automáticamente)
        </span>
      </h3>
      
      <div class="embedded-table">
        <div class="table-header grid-presupuesto">
          <div style="text-align: left;">Entidad</div>
          <div>No Monetario (S/)</div>
          <div>Monetario (S/)</div>
          <div>Total Fila</div>
          <div></div>
        </div>

        <div formArrayName="presupuestoEntidades">
          <div *ngFor="let entidad of presupuestoEntidades.controls; let i = index" [formGroupName]="i" class="table-row grid-presupuesto">
            
            <mat-form-field appearance="outline" subscriptSizing="dynamic">
              <input matInput formControlName="nombreEntidad" placeholder="Nombre Entidad" required />
            </mat-form-field>
      
            <mat-form-field appearance="outline" subscriptSizing="dynamic">
              <input matInput type="text" formControlName="aporteNoMonetario" placeholder="0.00"
                (focus)="onCurrencyFocus($event, entidad.get('aporteNoMonetario'))"
                (blur)="onCurrencyBlur($event, entidad.get('aporteNoMonetario'))" />
            </mat-form-field>
      
            <mat-form-field appearance="outline" subscriptSizing="dynamic">
              <input matInput type="text" formControlName="aporteMonetario" placeholder="0.00"
                (focus)="onCurrencyFocus($event, entidad.get('aporteMonetario'))"
                (blur)="onCurrencyBlur($event, entidad.get('aporteMonetario'))" />
            </mat-form-field>
      
            <div class="total-display" style="text-align: center;">
               {{ ((entidad.get('aporteNoMonetario')?.value || 0) + (entidad.get('aporteMonetario')?.value || 0)) | currency:'S/ ' }}
            </div>
      
            <div class="delete-btn-col">
              <button mat-icon-button color="warn" type="button" (click)="eliminarEntidadPresupuesto(i)"
                [disabled]="presupuestoEntidades.length <= 1" matTooltip="Eliminar fila">
                <mat-icon>delete</mat-icon>
              </button>
            </div>

          </div>
        </div>
      </div>
      
      <button mat-button color="primary" type="button" (click)="agregarEntidadPresupuesto()">
        <mat-icon>add_circle_outline</mat-icon> Añadir Entidad
      </button>
    </div>

    <div *ngIf="reportType === 'pic'">
      <h3>Presupuesto PIC</h3>
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Presupuesto Total Asignado</mat-label>
        <input matInput type="text" formControlName="presupuestoTotalPic" placeholder="0.00"
          (focus)="onCurrencyFocus($event, metadataForm.get('presupuestoTotalPic'))"
          (blur)="onCurrencyBlur($event, metadataForm.get('presupuestoTotalPic'))" />
      </mat-form-field>
    </div>

    <h3>Ingresos / Transferencias</h3>
    <div class="embedded-table">
      <div class="table-header grid-ingresos">
        <div style="text-align: left;">Descripción (Ej: R.R Nº...)</div>
        <div>Monto (S/)</div>
        <div></div>
      </div>

      <div formArrayName="ingresos">
        <div *ngFor="let ingreso of ingresos.controls; let i=index" [formGroupName]="i" class="table-row grid-ingresos">
          
          <mat-form-field appearance="outline" subscriptSizing="dynamic">
            <input matInput formControlName="descripcion" placeholder="Descripción del ingreso" />
          </mat-form-field>

          <mat-form-field appearance="outline" subscriptSizing="dynamic">
            <input matInput type="text" formControlName="monto" placeholder="0.00"
                   (focus)="onCurrencyFocus($event, ingreso.get('monto'))"
                   (blur)="onCurrencyBlur($event, ingreso.get('monto'))">
          </mat-form-field>

          <div class="delete-btn-col">
            <button mat-icon-button color="warn" (click)="eliminarIngreso(i)" type="button">
              <mat-icon>delete</mat-icon>
            </button>
          </div>

        </div>
      </div>
    </div>
    <button mat-button color="primary" type="button" (click)="agregarIngreso()">
      <mat-icon>add_circle_outline</mat-icon> Añadir Ingreso
    </button>


    <h3>Ejecución Años Anteriores</h3>
    <p style="font-size: 0.9em; color: #64748b; margin-top: -10px; margin-bottom: 10px;">
        Ingrese los montos acumulados por categoría para cada año previo.
    </p>

    <div class="embedded-table">
      <div class="table-header grid-gastos-ant">
        <div>Año</div>
        <div>B. Corrientes</div>
        <div>B. Capital</div>
        <div>Servicios</div>
        <div>Subvención</div>
        <div>Viáticos</div>
        <div>Encargo</div>
        <div></div>
      </div>

      <div formArrayName="gastosAnosAnteriores">
        <div *ngFor="let gastoGroup of gastosAnosAnteriores.controls; let i = index" [formGroupName]="i" class="table-row grid-gastos-ant">
          
          <mat-form-field appearance="outline" subscriptSizing="dynamic">
            <input matInput type="number" formControlName="year" placeholder="2024" style="text-align: center; font-weight: bold;">
          </mat-form-field>

          <mat-form-field appearance="outline" subscriptSizing="dynamic">
            <input matInput type="text" formControlName="bienesCorrientes" placeholder="0.00"
              (focus)="onCurrencyFocus($event, gastoGroup.get('bienesCorrientes'))"
              (blur)="onCurrencyBlur($event, gastoGroup.get('bienesCorrientes'))">
          </mat-form-field>

          <mat-form-field appearance="outline" subscriptSizing="dynamic">
            <input matInput type="text" formControlName="bienesCapital" placeholder="0.00"
              (focus)="onCurrencyFocus($event, gastoGroup.get('bienesCapital'))"
              (blur)="onCurrencyBlur($event, gastoGroup.get('bienesCapital'))">
          </mat-form-field>

          <mat-form-field appearance="outline" subscriptSizing="dynamic">
            <input matInput type="text" formControlName="servicios" placeholder="0.00"
              (focus)="onCurrencyFocus($event, gastoGroup.get('servicios'))"
              (blur)="onCurrencyBlur($event, gastoGroup.get('servicios'))">
          </mat-form-field>

          <mat-form-field appearance="outline" subscriptSizing="dynamic">
            <input matInput type="text" formControlName="subvencion" placeholder="0.00"
              (focus)="onCurrencyFocus($event, gastoGroup.get('subvencion'))"
              (blur)="onCurrencyBlur($event, gastoGroup.get('subvencion'))">
          </mat-form-field>

          <mat-form-field appearance="outline" subscriptSizing="dynamic">
            <input matInput type="text" formControlName="viaticos" placeholder="0.00"
              (focus)="onCurrencyFocus($event, gastoGroup.get('viaticos'))"
              (blur)="onCurrencyBlur($event, gastoGroup.get('viaticos'))">
          </mat-form-field>

          <mat-form-field appearance="outline" subscriptSizing="dynamic">
            <input matInput type="text" formControlName="encargoInterno" placeholder="0.00"
              (focus)="onCurrencyFocus($event, gastoGroup.get('encargoInterno'))"
              (blur)="onCurrencyBlur($event, gastoGroup.get('encargoInterno'))">
          </mat-form-field>

          <div class="delete-btn-col">
            <button mat-icon-button color="warn" type="button" (click)="eliminarGastoAnoAnterior(i)" 
                    [disabled]="gastosAnosAnteriores.length <= 1">
              <mat-icon>delete</mat-icon>
            </button>
          </div>

        </div>
      </div>
    </div>
    
    <button mat-button color="primary" type="button" (click)="agregarGastoAnoAnterior()">
      <mat-icon>add_circle_outline</mat-icon> Añadir Año
    </button>

  </form>
</mat-dialog-content>

<mat-dialog-actions align="end" style="padding: 16px 24px;">
  <button mat-button (click)="dialogRef.close(undefined)">Cancelar</button>
  <button mat-button (click)="onOmitir()" style="color: #64748b;">Omitir Datos</button>
  <button mat-raised-button color="primary" (click)="onGenerar()">
    <mat-icon>save_alt</mat-icon> Generar Reporte
  </button>
</mat-dialog-actions>